@startuml KartaActivity_PermissionCheck
title Karta (Plats√•tkomst beg√§rs endast en g√•ng)

skinparam backgroundColor #F8FAFC
skinparam activity {
  BackgroundColor<<Client>> #E3F2FD
  BackgroundColor<<OS>> #FFF8E1
  BackgroundColor<<Server>> #E8F5E9
  BackgroundColor<<Error>> #FFEBEE
  BorderColor #333
}
skinparam partitionBorderColor #333
skinparam noteBackgroundColor #FFFDE7
skinparam noteBorderColor #E0E0E0

start

partition "üì± Klient (Expo-app)" <<Client>> {
  :Anv√§ndaren √∂ppnar kartvyn;
  :Visa loading-indikator;
  :Kontrollera plats√•tkomst med `getForegroundPermissionsAsync()`;

  if (Tillst√•nd redan beviljat?) then (Ja)
    :H√§mta aktuell position med `getCurrentPositionAsync()`;
  else (Nej)
    :Beg√§r plats√•tkomst via `requestForegroundPermissionsAsync()`;
  endif
}

partition "üß© OS (iOS / Android)" <<OS>> {
  if (Beg√§ran skickad?) then (Ja)
    :Visa system-prompt "Till√•t Fishing Diary att anv√§nda din plats?";
    if (Anv√§ndaren nekar?) then (Ja)
      :Returnera status = denied;
    else (Nej)
      :Returnera status = granted;
    endif
  endif
}

partition "üì± Klient (Expo-app)" <<Client>> {
  if (status == denied) then (Ja)
    :Visa alert "Plats√•tkomst kr√§vs f√∂r att visa karta"; <<Error>>
    stop
  else (Nej)
    :H√§mta position (GPS-data);
    :Skicka position + anv√§ndar-ID till servern;
  endif
}

partition "üñ•Ô∏è Server (Supabase)" <<Server>> {
  :Verifiera anv√§ndarsession;
  :H√§mta anv√§ndarens f√•ngster fr√•n databasen;
  :Returnera lista med koordinater och metadata;
}

partition "üì± Klient (Expo-app)" <<Client>> {
  :D√∂lj loading-indikator;
  :Visa karta via `react-native-maps`;
  :Placera mark√∂rer f√∂r alla f√•ngster;

  if (Anv√§ndaren trycker p√• mark√∂r?) then (Ja)
    :Visa detaljerad information i modal/panel;
  endif

  if (Anv√§ndaren l√•ngtrycker p√• kartan?) then (Ja)
    :H√§mta vald koordinat;
    :Fr√•ga "Vill du l√§gga till en ny f√•ngst h√§r?";
    if (Bekr√§ftar?) then (Ja)
      :√ñppna formul√§ret "Ny f√•ngst" med vald position;
    endif
  endif

  :Anv√§ndaren kan panorera, zooma, uppdatera kartan;
}

stop
@enduml